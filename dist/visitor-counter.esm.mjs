import{randomUUID as e}from"crypto";import t from"fast-geoip";import{MongoClient as n}from"mongodb";import o from"url";const r=new Intl.DisplayNames(["en"],{type:"region"}),i=async e=>({total:e.length,countries:e.reduce(((e,{country:t})=>({...e,[t]:(e[t]||0)+1})),{})}),a=864e5,c={second:1e3,minute:6e4,hour:36e5,day:a,week:6048e5,month:2627856e3,year:31534272e3};var s=async({mongourl:a="mongodb://localhost:27017/",dbName:s="visitor-counter-db",ttl:u=3600,id:d="default",cookieKey:l="visitor-counter-id"}={})=>{const p=await(({mongourl:e,dbName:t,id:o,ttl:r}={})=>new Promise((i=>{const a=e.endsWith("/")?e.slice(0,-1):e;n.connect(`${a}/${t}`,(async(e,n)=>{if(e)throw e;const a=n.db(t),c=a.collection(`visitors-${o}`),s=a.collection(`visitors-${o}-current`);try{s.createIndex({createdAt:1},{expireAfterSeconds:r})}catch(e){console.log(e)}i({setTTL:e=>{try{s.dropIndexes(),s.createIndex({createdAt:1},{expireAfterSeconds:e})}catch(e){console.log(e)}},setVisitor:e=>{try{return s.insertOne({id:e,createdAt:new Date})}catch(e){console.log(e)}},getVisitor:async e=>{try{return await s.findOne({id:e})}catch(e){console.log(e)}},getVisitorCount:async()=>new Promise(((e,t)=>{s.count({},((o,r)=>{o&&(n.close(),t(o)),e(r)}))})),set:e=>{try{if(e)return c.insertOne(e)}catch(e){console.log(e)}},get:(e={})=>new Promise(((t,o)=>{c.find(e,{projection:{_id:0}}).toArray(((e,r)=>{e&&(n.close(),o(e)),t(r)}))}))})}))})))({id:d,mongourl:a,dbName:s,ttl:u});async function m(e){if(!e)return i(await p.get());const[t,n]=e.split("-"),o=c[t]?Date.now()-c[t]:new Date(t).getTime(),r=n?new Date(n).getTime():Date.now(),a=await p.get({date:{$gte:o,$lte:r}});return i(a)}return{record:async(n,o,i)=>{const a=(c=n.headers.cookie,c?c.split(";").map((e=>e.split("="))).reduce(((e,[t,n])=>({...e,[decodeURIComponent(t.trim())]:decodeURIComponent(n.trim())})),{}):{})[`${l}-${d}`];var c;if(!await p.getVisitor(a)){const i=e();p.setVisitor(i),p.set(await(async e=>{const n=(e.headers["x-forwarded-for"]||"").split(",")[0]||e.connection.remoteAddress;if(!n||"::ffff:127.0.0.1"===n)return;const o=await t.lookup(n);return{ip:n,countryCode:o?.country||!1,country:!!o&&r.of(o.country),date:Date.now()}})(n)),o.setHeader("Set-Cookie",`${l}-${d}=${i}`)}"function"==typeof i&&i()},get:m,visitors:async()=>await p.getVisitorCount(),async ui(e,t,n){const{pathname:r,query:i}=o.parse(e.url,!0);"visitor-counter"!==r.replaceAll("/","")&&(i.range||t.end('<!DOCTYPE html>\n<html lang="en">\n  <head>\n    <meta charset="UTF-8" />\n    <meta http-equiv="X-UA-Compatible" content="IE=edge" />\n    <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n    <title>visitor-counter</title>\n  </head>\n  <body>\n    <code>\n      <pre style="margin: 0;">ðŸ“ˆðŸ‘€\n      \n<input style="width: 236px" type="range" min="0" max="7" step="1" value="3">\n |   |   |   |   |   |   |   |\n s   m   h   d   w   m   y  all\n\n<output style="color: dodgerblue;background: #f5f5f5;display: inline-block;padding: 1em 4em 1em 1em;border-radius: 5px;"></output>\n      </pre>\n    </code>\n    <script>\n      const map = {\n        0: \'/?range=second\',\n        1: \'/?range=minute\',\n        2: \'/?range=hour\',\n        3: \'/?range=day\',\n        4: \'/?range=week\',\n        5: \'/?range=month\',\n        6: \'/?range=year\',\n        7: \'/?range=all\'\n      }\n      const input = document.querySelector(\'input\')\n      const output = document.querySelector(\'output\')\n      input.addEventListener(\'input\', ({ target: { value } }) => updateOutput(value))\n      updateOutput(3)\n      async function updateOutput(value) {\n        output.textContent = await fetch(\'/visitor-counter\' + map[value]).then(res =>\n          res.text()\n        )\n      }\n    <\/script>\n  </body>\n</html>\n'),t.end(JSON.stringify(await m("all"!==i.range&&i.range),null,2))),"function"==typeof n&&n()}}};export{s as default};
