import{randomUUID as e}from"crypto";import t from"fast-geoip";import{MongoClient as o}from"mongodb";const n=new Intl.DisplayNames(["en"],{type:"region"}),r=async e=>({total:e.length,countries:e.reduce(((e,{country:t})=>({...e,[t]:(e[t]||0)+1})),{})}),i=864e5,s={second:1e3,minute:6e4,hour:36e5,day:i,week:6048e5,month:2627856e3,year:31534272e3};var a=async({mongourl:i="mongodb://localhost:27017/",dbName:a="visitor-counter-db",ttl:c=3600,id:d="default",cookieKey:m="visitor-counter-id"}={})=>{const u=await(({mongourl:e,dbName:t,id:n,ttl:r}={})=>new Promise((i=>{const s=e.endsWith("/")?e.slice(0,-1):e;o.connect(`${s}/${t}`,(async(e,o)=>{if(e)throw e;const s=o.db(t),a=s.collection(`visitors-${n}`),c=s.collection(`visitors-${n}-current`);c.dropIndexes(),c.createIndex({createdAt:1},{expireAfterSeconds:r}),i({setTTL:e=>{c.dropIndexes(),c.createIndex({createdAt:1},{expireAfterSeconds:e})},setVisitor:e=>c.insertOne({id:e,createdAt:new Date}),getVisitor:async e=>await c.findOne({id:e}),getVisitorCount:async()=>new Promise((e=>{c.count({},((t,n)=>{if(t)throw o.close(),t;e(n)}))})),set:e=>e&&a.insertOne(e),get:(e={})=>new Promise((t=>{a.find(e,{projection:{_id:0}}).toArray(((e,n)=>{if(e)throw o.close(),e;t(n)}))}))})}))})))({id:d,mongourl:i,dbName:a,ttl:c});return{record:async(o,r,i)=>{const s=(a=o.headers.cookie,a?a.split(";").map((e=>e.split("="))).reduce(((e,[t,o])=>({...e,[decodeURIComponent(t.trim())]:decodeURIComponent(o.trim())})),{}):{})[`${m}-${d}`];var a;if(!await u.getVisitor(s)){const i=e();u.setVisitor(i),u.set(await(async e=>{const o=(e.headers["x-forwarded-for"]||"").split(",")[0]||e.connection.remoteAddress;if(!o||"::ffff:127.0.0.1"===o)return;const r=await t.lookup(o);return{ip:o,countryCode:r?.country||!1,country:!!r&&n.of(r.country),date:Date.now()}})(o)),r.setHeader("Set-Cookie",`${m}-${d}=${i}`)}"function"==typeof i&&i()},get:async e=>{if(!e)return r(await u.get());const[t,o]=e.split("-"),n=s[t]?Date.now()-s[t]:new Date(t).getTime(),i=o?new Date(o).getTime():Date.now(),a=await u.get({date:{$gte:n,$lte:i}});return r(a)},visitors:async()=>await u.getVisitorCount()}};export{a as default};
