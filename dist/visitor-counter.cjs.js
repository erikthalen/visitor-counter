"use strict";var e=require("crypto"),t=require("fast-geoip"),o=require("mongodb");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=n(t);const i=new Intl.DisplayNames(["en"],{type:"region"}),s=async e=>({total:e.length,countries:e.reduce(((e,{country:t})=>({...e,[t]:(e[t]||0)+1})),{})}),a=864e5,c={second:1e3,minute:6e4,hour:36e5,day:a,week:6048e5,month:2627856e3,year:31534272e3};module.exports=async({mongourl:t="mongodb://localhost:27017/",dbName:n="visitor-counter-db",ttl:a=3600,id:d="default",cookieKey:u="visitor-counter-id"}={})=>{const l=await(({mongourl:e,dbName:t,id:n,ttl:r}={})=>new Promise((i=>{const s=e.endsWith("/")?e.slice(0,-1):e;o.MongoClient.connect(`${s}/${t}`,(async(e,o)=>{if(e)throw e;const s=o.db(t),a=s.collection(`visitors-${n}`),c=s.collection(`visitors-${n}-current`);c.dropIndexes(),c.createIndex({createdAt:1},{expireAfterSeconds:r}),i({setTTL:e=>{c.dropIndexes(),c.createIndex({createdAt:1},{expireAfterSeconds:e})},setVisitor:e=>c.insertOne({id:e,createdAt:new Date}),getVisitor:async e=>await c.findOne({id:e}),getVisitorCount:async()=>new Promise((e=>{c.count({},((t,n)=>{if(t)throw o.close(),t;e(n)}))})),set:e=>e&&a.insertOne(e),get:(e={})=>new Promise((t=>{a.find(e,{projection:{_id:0}}).toArray(((e,n)=>{if(e)throw o.close(),e;t(n)}))}))})}))})))({id:d,mongourl:t,dbName:n,ttl:a});return{record:async(t,o,n)=>{const s=(a=t.headers.cookie,a?a.split(";").map((e=>e.split("="))).reduce(((e,[t,o])=>({...e,[decodeURIComponent(t.trim())]:decodeURIComponent(o.trim())})),{}):{})[`${u}-${d}`];var a;if(!await l.getVisitor(s)){const n=e.randomUUID();l.setVisitor(n),l.set(await(async e=>{const t=(e.headers["x-forwarded-for"]||"").split(",")[0]||e.connection.remoteAddress;if(!t||"::ffff:127.0.0.1"===t)return;const o=await r.default.lookup(t);return{ip:t,countryCode:o?.country||!1,country:!!o&&i.of(o.country),date:Date.now()}})(t)),o.setHeader("Set-Cookie",`${u}-${d}=${n}`)}"function"==typeof n&&n()},get:async e=>{if(!e)return s(await l.get());const[t,o]=e.split("-"),n=c[t]?Date.now()-c[t]:new Date(t).getTime(),r=o?new Date(o).getTime():Date.now(),i=await l.get({date:{$gte:n,$lte:r}});return s(i)},visitors:async()=>await l.getVisitorCount()}};
